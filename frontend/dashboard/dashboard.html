<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Finance Manager</title>
    <link rel="stylesheet" href="./css/dashboard.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div class="header">
        <h1>Finance Manager</h1>
        <h2>Dashboard</h2>
        <h2>Export/Import</h2>
        <h2>(Icon für profile)</h2>
        <img src="./img/user-icon.png" alt="User Icon" class="user-icon">
    </div>

    <!-- File Input als Fallback -->
    <input type="file" id="csvFileInput" accept=".csv" style="display: none;">

    <div class="content">
        <h2>Welcome to the Dashboard</h2>
        <div class="time-dropdown">
            <label for="timeframe">Zeitraum: </label>
            <select id="timeframe">
                <option value="last30days">This month</option>
                <option value="last90days">Last 3 months</option>
                <option value="last180days">Last 6 months</option>
                <option value="lastYear">Last year</option>
                <option value="custom">All time</option>
            </select>
        </div>

        <div id="dragOverlay" class="drag-drop-overlay">
            <div class="drag-box">
                <h2>Drop CSV here</h2>
                <p>(Nothing will happen yet)</p>
            </div>
        </div>

        <div class="data">
            <div class="balance">
                <h3>Current Balance</h3>
                <p>€5,000</p>
                <a>(+5% since last month)</a>
            </div>
            <div class="expenses">
                <h3>Current Expenses</h3>
                <p>€2,000</p>
                <a>(+12% since last month)</a>
            </div>
            <div class="income">
                <h3>Current Income</h3>
                <p>€7,000</p>
                <a>(+8% since last month)</a>
            </div>
            <div class="budget">
                <h3>Budget goal</h3>
                <p>56%</p>
                <a>(352.32€ of 630.00€)</a>
            </div>
            <div class="transactions">
                <h3>Recent Transactions</h3>
                <div class="transactions-grid">
                    <!-- Column headers -->
                    <div class="cell head amount">Amount</div>
                    <div class="cell head merchant">Merchant</div>
                    <div class="cell head category">Category</div>
                    <div class="cell head date">Date</div>

                    <!-- Row 1 -->
                    <div class="cell amount negative">-€61.90</div>
                    <div class="cell merchant">Pandora DE</div>
                    <div class="cell category">Shopping</div>
                    <div class="cell date">24.08.2025</div>

                    <!-- Row 2 -->
                    <div class="cell amount positive">+€500.00</div>
                    <div class="cell merchant">GKM Interactive</div>
                    <div class="cell category">Salary</div>
                    <div class="cell date">24.08.2025</div>

                    <!-- Row 3 -->
                    <div class="cell amount negative">-€26.30</div>
                    <div class="cell merchant">McDonalds</div>
                    <div class="cell category">Food</div>
                    <div class="cell date">25.08.2025</div>
                </div>
            </div>
        </div>

    </div>

</body>
</html>

<style>
body {
  background-color: #0a2540;
  font-family: 'Montserrat', sans-serif;
  margin: 0;
  padding: 0;
  color: #ffffff;
}

.content {
    max-width: 1500px;
    margin: 40px auto;
    padding: 32px;
    width: 100%;
    box-sizing: border-box;
    background: rgba(255, 255, 255, 0.144);
    border-radius: 24px;
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.18);
}

.time-dropdown {
    background: rgba(255, 255, 255, 0.25);
    border-radius: 16px;
    box-shadow: 0 4px 16px 0 rgba(31, 38, 135, 0.17);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.18);
    padding: 12px 24px;
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    position: absolute;
    top: 32px;
    right: 32px;
}

#timeframe {
    background: rgba(255, 255, 255, 0.35);
    border: 1px solid rgba(255, 255, 255, 0.18);
    box-shadow: 0 2px 8px 0 rgba(31, 38, 135, 0.10);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    border-radius: 7px;
    padding: 6px 12px;
    font-family: 'Montserrat', sans-serif;
    margin-left: 5px;
    align-items: center;
}

.data {
    display: flex;
    gap: 24px;
    flex-wrap: wrap;
    justify-content: flex-start;
}

.balance,
.expenses, .income, .budget {
    flex: 1 1 220px;
    max-width: 250px;
    min-width: 220px;
    background: rgba(255, 255, 255, 0.226);
    border-radius: 18px;
    box-shadow: 0 4px 24px 0 rgba(31, 38, 135, 0.18);
    border: 1px solid rgba(255, 255, 255, 0.22);
    padding: 18px;
    margin-top: 10px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
}

.balance h3,
.expenses h3, .income h3, .budget h3 {
    font-size: 1.1em;
    margin-bottom: 8px;
    margin-top: 0px;
}

.balance p,
.expenses p, .income p, .budget p {
    font-size: 1.8em;
    margin: 0;
}

.balance a,
.expenses a, .income a, .budget a {
    font-size: 0.9em;
    color: #ebebeb;
    margin-top: 4px;
}

.transactions {
    flex-basis: 100%;
    max-width: 100%;
    background: rgba(255, 255, 255, 0.205);
    border-radius: 18px;
    box-shadow: 0 4px 24px 0 rgba(31, 38, 135, 0.18);
    border: 1px solid rgba(255, 255, 255, 0.22);
    padding: 18px 18px 26px;
    box-sizing: border-box;
}

.transactions h3 {
    margin: 5px 5px 14px;
}

.transactions-grid {
    display: grid;
    grid-template-columns: 110px 1fr 150px 120px;
    gap: 10px 28px;
    font-variant-numeric: tabular-nums;
    align-content: stretch;
    justify-items: center;
}

.transactions-grid .cell {
    justify-self: stretch;
    text-align: left;
}

.transactions-grid .cell {
    white-space: nowrap;
    overflow: hidden;
    /* text-overflow: ellipsis; */
    font-size: 0.95rem;
    line-height: 1.25rem;
}

.transactions-grid .head {
    font-size: 0.70rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    font-weight: 600;
    opacity: 0.85;
    padding-bottom: 4px;
    border-bottom: 1px solid rgba(255,255,255,0.28);
}

.transactions-grid .amount {
    font-weight: 700;
    text-align: left; /* left anchor */
}

.transactions-grid .amount.positive {
    color: #05c39d;
}

.transactions-grid .amount.negative {
    color: #ff4d4d;
}

.transactions-grid .merchant {
    font-weight: 600;
}

.transactions-grid .category {
    color: #eaeaea;
    opacity: 0.95;
}

.transactions-grid .date {
    color: #e6e6e6;
    opacity: 0.9;
}

/* Optional subtle row separators (skip header) */
.transactions-grid .amount:not(.head) {
    position: relative;
}
.transactions-grid .amount:not(.head)::before {
    content: "";
    position: absolute;
    left: -8px;
    right: -9999px;
    top: -5px;
    bottom: -5px;
    border-radius: 10px;
    background: rgba(255,255,255,0.04);
    pointer-events: none;
}

/* Hover highlight (full row) */
.transactions-grid .amount:not(.head):hover::before {
    background: rgba(255,255,255,0.09);
}

/* Make entire logical row react on hover by pairing siblings */
.transactions-grid .amount:not(.head):hover ~ .merchant:nth-of-type(n),
.transactions-grid .amount:not(.head):hover ~ .category:nth-of-type(n),
.transactions-grid .amount:not(.head):hover ~ .date:nth-of-type(n) {
    /* (No extra style needed; backdrop already applied via ::before) */
}

/* Responsive: stack columns */
@media (max-width: 700px) {
    .transactions-grid {
        grid-template-columns: 1fr 1fr;
        gap: 8px 16px;
    }

    .transactions-grid .head {
        grid-column: span 2;
    }

    /* Make each data row span 2 columns in pairs:
       Amount + Merchant on first line, Category + Date on second */
    .transactions-grid .amount:not(.head),
    .transactions-grid .merchant,
    .transactions-grid .category,
    .transactions-grid .date {
        white-space: normal;
    }
}



.drag-drop-overlay {
    position: fixed;
    inset: 0;
    background: rgba(10,37,64,0.78);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    transition: opacity .18s ease;
    color: #fff;
}
.drag-drop-overlay .drag-box {
    padding: 48px 72px;
    border: 2px dashed rgba(255,255,255,0.35);
    border-radius: 28px;
    background: rgba(255,255,255,0.08);
    text-align: center;
    box-shadow: 0 10px 40px -10px rgba(0,0,0,0.55);
}
.drag-drop-overlay .drag-box h2 {
    margin: 0 0 8px;
    font-weight: 600;
    letter-spacing: .5px;
}
.drag-drop-overlay .drag-box p {
    margin: 0;
    opacity: 0.8;
    font-size: .9rem;
}
.drag-drop-overlay.active {
    display: flex;
}
</style>

<script>
// Drag & Drop functionality
(function setupDragOverlay(){
    const overlay = document.getElementById('dragOverlay');
    let dragCounter = 0;

    function show() {
        overlay.classList.add('active');
    }
    function hide() {
        overlay.classList.remove('active');
    }

    window.addEventListener('dragenter', (e) => {
        dragCounter++;
        if (e.dataTransfer && e.dataTransfer.types.includes('Files')) show();
    });

    window.addEventListener('dragover', (e) => {
        e.preventDefault();
    });

    window.addEventListener('dragleave', () => {
        dragCounter--;
        if (dragCounter <= 0) {
            dragCounter = 0;
            hide();
        }
    });

    window.addEventListener('drop', (e) => {
        e.preventDefault();
        dragCounter = 0;
        hide();
    });
})();


// init a indexedDB here now
function initDB() {
    return new Promise((resolve, reject) => {
        const req = indexedDB.open('financeManager', 1);
        req.onupgradeneeded = e => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains('transactions')) {
                const store = db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                store.createIndex('date', 'date');
                store.createIndex('type', 'type');
                store.createIndex('merchant', 'merchant');
            }
        };
        req.onsuccess = e => resolve(e.target.result);
        req.onerror = e => reject(e.target.error);
    });
}

function getDB() {
    if (!window._fmDBPromise) window._fmDBPromise = initDB();
    return window._fmDBPromise;
}

function addTransaction(txObj) {
    return getDB().then(db => new Promise((resolve, reject) => {
        const tx = db.transaction('transactions', 'readwrite');
        tx.objectStore('transactions').add(txObj);
        tx.oncomplete = () => resolve(true);
        tx.onerror = e => reject(e.target.error);
    }));
}

function loadAllTransactions() {
    return getDB().then(db => new Promise((resolve, reject) => {
        const tx = db.transaction('transactions', 'readonly');
        const store = tx.objectStore('transactions');
        const all = [];
        store.openCursor().onsuccess = e => {
            const cur = e.target.result;
            if (cur) { all.push(cur.value); cur.continue(); } else resolve(all);
        };
        tx.onerror = e => reject(e.target.error);
    }));
}

function buildFingerprint(rec) {
    const date = rec.date || '';
    const merchant = (rec.merchant || '').toLowerCase().replace(/\s+/g,' ').trim();
    const amountNum = typeof rec.amount === 'number' ? rec.amount : parseFloat(rec.amount || 0);
    const amount = isNaN(amountNum) ? '0.00' : amountNum.toFixed(2);
    return [date, merchant, amount].join('||');
}

function bulkAddTransactions(list) {
    return Promise.all([getDB(), loadAllTransactions()]).then(([db, existing]) => new Promise((resolve, reject) => {
        const existingSet = new Set(existing.map(buildFingerprint));
        const toAdd = [];
        list.forEach(r => {
            const fp = buildFingerprint(r);
            if (!existingSet.has(fp)) {
                existingSet.add(fp);
                toAdd.push(r);
            }
        });
        if (!toAdd.length) return resolve({ added: 0, skipped: list.length });
        const tx = db.transaction('transactions', 'readwrite');
        const store = tx.objectStore('transactions');
        toAdd.forEach(o => store.add(o));
        tx.oncomplete = () => resolve({ added: toAdd.length, skipped: list.length - toAdd.length });
        tx.onerror = e => reject(e.target.error);
    }));
}

function parseCSV(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim().length);
    const out = [];
    const tsRegex = /\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/;
    function cleanAmount(a) {
        let s = a.replace(/"/g,'').trim();
        s = s.replace(/\./g,'').replace(',','.');
        return parseFloat(s);
    }
    lines.forEach(line => {
        if (line.startsWith('"offen";"--";')) {
            const parts = line.split(';');
            if (parts.length < 5) return;
            let amount = cleanAmount(parts[4]);
            let merchantRaw = parts[3].replace(/"/g,'').trim();
            merchantRaw = merchantRaw.split('Buchungstext: ')[1] || merchantRaw;
            const tsMatch = merchantRaw.match(tsRegex);
            let ts = null;
            if (tsMatch) {
                ts = tsMatch[0];
                merchantRaw = merchantRaw.replace(ts,'').trim();
            }
            out.push({
                type: 'open_withdrawal',
                date: null,
                merchant: merchantRaw,
                amount: amount,
                timestamp: ts
            });
            return;
        }
        if (line.includes('"Lastschrift / Belastung"') || line.includes('"Kartenverf')) {
            const parts = line.split(';');
            if (parts.length < 5) return;
            let date = parts[0].replace(/"/g,'').trim();
            let amount = cleanAmount(parts[4]);
            let merchant = parts[3].replace(/"/g,'').trim();
            if (merchant.includes('Buchungstext: ')) {
                merchant = merchant.split('Buchungstext: ')[1].trim();
                merchant = merchant.split(' Karte Nr.')[0].trim();
            }
            const tsMatch = merchant.match(tsRegex);
            let ts = null;
            if (tsMatch) {
                ts = tsMatch[0];
                merchant = merchant.split(ts)[0].trim();
            }
            out.push({
                type: 'expense',
                date: date,
                merchant: merchant,
                amount: amount,
                timestamp: ts
            });
            return;
        }
        if (line.includes('"Übertrag / Überweisung"') || line.includes('"�bertrag / �berweisung"')) {
            const parts = line.split(';');
            if (parts.length < 5) return;
            let date = parts[0].replace(/"/g,'').trim();
            let amountRaw = parts[4];
            if (amountRaw.startsWith('"-')) return;
            let amount = cleanAmount(amountRaw);
            let source = parts[3].replace(/"/g,'').trim();
            if (source.includes('Auftraggeber: ')) {
                source = source.split('Auftraggeber: ')[1].trim();
                source = source.split(' Buchungstext:')[0].trim();
            }
            out.push({
                type: 'income',
                date: date,
                merchant: source,
                amount: amount,
                timestamp: null
            });
            return;
        }
    });
    return out;
}

function parseDateGerman(d) {
    if (!d) return null;
    const m = d.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
    if (!m) return null;
    return new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]));
}

function filterTransactionsByTimeframe(list, tf) {
    if (tf === 'custom') return list;
    const now = new Date();
    let days = 30;
    if (tf === 'last90days') days = 90;
    else if (tf === 'last180days') days = 180;
    else if (tf === 'lastYear') days = 365;
    const cutoff = new Date(now.getTime() - days * 86400000);
    return list.filter(t => {
        const dt = parseDateGerman(t.date);
        if (!dt) return false;
        return dt >= cutoff;
    });
}

function renderTransactions(list) {
    const grid = document.querySelector('.transactions-grid');
    if (!grid) return;
    const headerNodes = Array.from(grid.children).slice(0, 4); // keep first 4 (headers)
    grid.innerHTML = '';
    headerNodes.forEach(n => grid.appendChild(n));
    list.sort((a, b) => {
        const da = parseDateGerman(a.date) || 0;
        const db = parseDateGerman(b.date) || 0;
        return db - da;
    });
    list.forEach(t => {
        const amount = Number(t.amount || 0);
        const amountEl = document.createElement('div');
        amountEl.className = 'cell amount ' + (amount >= 0 ? 'positive' : 'negative');
        amountEl.textContent = (amount >= 0 ? '+' : '') + amount.toFixed(2) + '€';
        const merchantEl = document.createElement('div');
        merchantEl.className = 'cell merchant';
        merchantEl.textContent = t.merchant || '(Unknown)';
        const categoryEl = document.createElement('div');
        categoryEl.className = 'cell category';
        categoryEl.textContent = t.type || '';
        const dateEl = document.createElement('div');
        dateEl.className = 'cell date';
        dateEl.textContent = t.date || '';
        grid.appendChild(amountEl);
        grid.appendChild(merchantEl);
        grid.appendChild(categoryEl);
        grid.appendChild(dateEl);
    });
}

function refreshTransactionsView() {
    const select = document.getElementById('timeframe');
    const tf = select ? select.value : 'last30days';
    loadAllTransactions().then(all => {
        const filtered = filterTransactionsByTimeframe(all, tf);
        renderTransactions(filtered);
    });
}

function startup() {
    getDB().then(() => {
        attachFileHandlers();
        const sel = document.getElementById('timeframe');
        if (sel) sel.addEventListener('change', refreshTransactionsView);
        refreshTransactionsView();
    });
}

function handleDroppedFile(file) {
    if (!file || !file.name.endsWith('.csv')) return;
    const reader = new FileReader();
    reader.onload = e => {
        const text = e.target.result;
        const parsed = parseCSV(text);
        bulkAddTransactions(parsed).then(res => {
            console.log('Imported transactions:', res);
            refreshTransactionsView();
        }).catch(err => console.error(err));
    };
    reader.readAsText(file, 'utf-8');
}

function attachFileHandlers() {
    const hiddenInput = document.getElementById('csvFileInput');
    if (hiddenInput) {
        hiddenInput.addEventListener('change', e => {
            const f = e.target.files[0];
            handleDroppedFile(f);
        });
    }
    window.addEventListener('drop', e => {
        if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length) {
            handleDroppedFile(e.dataTransfer.files[0]);
        }
    });
}

function startup() {
    getDB().then(() => {
        attachFileHandlers();
        const sel = document.getElementById('timeframe');
        if (sel) sel.addEventListener('change', refreshTransactionsView);
        refreshTransactionsView();
    });
}

document.addEventListener('DOMContentLoaded', startup);

</script>